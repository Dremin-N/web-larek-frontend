# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:

- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:

- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/appData.ts - файл с моделью данных приложения
- src/CatalogApi.ts - файл для взаимодействия с api приложения
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск

Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```

## Сборка

```
npm run build
```

или

```
yarn build
```

## Компоненты отображения

### Класс `Component`

Абстрактный класс, который реализует основные методы для отображения элементов на странице

#### Методы:

- `setText` - устанавливает текстовое содержимое

- `setDisabled` - изменяет статус блокировки для кнопки

- `setHidden` - скрывает элемент

- `setVisible` - делает элемент видимым

- `setImage` - устанавливает изображение с альтернативным текстом

- `render` - Возвращает HTML-элемент для отображения

- `toggleClass` - Переключение класса у элемента

### Классы которые наследуются от `Component`

### 1. Класс `Basket`

Отвечает за отображение Корзины. Хранит поля с HTML элементами для отображения списка товаров, общей суммы заказа и кнопки "Оформить".

Методы:

- `items` - задает список товаров для отображения в корзине
- `total` - устанавливает общую сумму заказа
- `selected` - Меняет статус кнопки "Оформить" в зависимости от наличия суммы товаров в корзине

### 2. Класс `Card`

Базовый класс для отображения карточки товара в трех интерфейсах: в каталоге, превью и корзине. Имеет сеттеры для установки значений в DOM-элементы — `id`, `title`, `category`, `image`, `price`, `description`, `index`.

- #### Класс `CardCatalog` отвечает за отображение в каталоге
- #### Класс `CardPreview` отвечает за отображение в превью

  Имеет метод `updateButtonText`, отвечающий за изменение текста на кнопке "В корзину"

- #### Класс `CardBasket` отвечает за отображение в Корзине

  Имеет сеттер `index`, отвечающий за отображение порядкового номера

### 3. Класс `Form`

В конструкторе принимает на вход элемент формы и брокер событий, вешает слушатель `input`. Также вешается слушатель `input` на всю форму, в котором вызывается метод `onInputChange` с передачей в него поля ввода и текущего значения в этом поле. Имеет поля для элементов кнопки сабмита, ошибки и список инпутов.

Имеет следующие методы:

- `onInputChange` - следит за изменениями в полях формы и генерирует событие с именем зависящим от имени контейнера и поля ввода.
- `valid` - Меняет статус кнопки `submit`
- `errors` - Устанавливает текст ошибки

### 4. Класс `Modal`

Класс отвечает за отображения контента в шаблоне модального окна. В конструкторе принимает элемент шаблона и брокер событий.

Методы:

- сеттер `content` - устанавливает контент в контейнер модального окна
- `open` - открывает модальное окно
- `close` - закрывает модальное окно

### 5. Класс `Success`

Отвечает за отображение модального окна при успешно оформленном заказе. Имеет сеттер `total`, который устанавливает значение суммы заказа.

### 6. Класс `Page`

Отвечает за отображение элементов на главной странице. В полях класса содержатся HTML элементы корзины, каталога, обертки и счетчика корзины.

Методы:

- `counter` - Устанавливает количество товаров в корзине
- `catalog` - Вставляет карточки товаров в контейнер каталога
- `locked` - Блокирует/разблокирует скролл при открытом модально окне

### 7. Класс `Order`

Класс наследуется от класса `Form<IOrderForm>` и отвечает за работу с формой заказа, содержащей поле адреса и выбор способа оплаты.

В классе реализованы сеттеры для установки значений в поля форм. Сохранение введенных данных будет реализовано через событийно-ориентированный подход.

Методы `onTabClick` и `updateTabs` отвечают за отображение вкладок выбора способа оплаты. Поле `_selectedPayment` хранит выбранный способ оплаты.

## Компоненты модели

### Класс `EventEmitter`

Реализует паттерн «Наблюдатель» и позволяет подписываться на события и уведомлять подписчиков о наступлении события.

Класс имеет методы `on`, `off` , `emit` — для подписки на событие, отписки от события и уведомления подписчиков о наступлении события соответственно.

Дополнительно реализованы методы `onAll` и `offAll` — для подписки на все события и сброса всех подписчиков.

Интересным дополнением является метод `trigger` , генерирующий заданное событие с заданными аргументами. Это позволяет передавать его в качестве обработчика события в другие классы. Эти классы будут генерировать события, не будучи при этом напрямую зависимыми от класса EventEmitter .

### Класс `Api`

Является базовым классом, который реализует основные методы для взаимодействия с api.

Имеет поля `baseUrl` - строка для запроса и `options` - объект заголовков запроса.

Методы класса:

- `handleResponse` - проверяет статус запроса от сервера, в случае некорректного ответа уводит `Promise` в блок `catch`;
- `get` - метод для отправки GET-запросов
- `post` - метод для отправки POST-запросов

### Класс `CatalogApi`

Наследуется от базового класса `Api`. Реализует основные методы взаимодействия с нужным Api.

- `getproductList` - получаем массив товаров с сервера
- `getProductItem` - Получаем объект товара с сервера
- `orderProducts` - Отправляем данные покупателя при оформлении заказа на сервер

### Класс `Model`

Абстрактный класс, который служит для реализации моделей данных. В конструкторе принимает объект данных и универсальный брокер событий. Имеет метод `emitChanges`, который уведомляет все слушатели, что произошло событие и если слушатели найдены, они срабатывают.

### Класс `AppState`

Наследуется от класса `Model` и имеет следующие поля:

1. `noPriceItems` - содержит массив id товаров, которые нельзя приобрести
2. `catalog` - содержит массив товаров в каталоге
3. `order` - содержит данные о заказе
4. `preview` - содержит данные об id товара для превью
5. `formErrors`- содержит данные об ошибках в полях ввода

#### Методы:

- `toggleOrderedItem` - добавляет и удаляет товары из корзины
- `clearOrder` - очищает форму заказа
- `getOrderedItems` - получает товары, находящиеся в корзине
- `getTotal` - получает сумму всех товаров в корзине
- `setCatalog` - устанавливает список товаров для каталога
- `setPreview` - устанавливает товар в режим превью
- `setNonBuyItems` - получает массив id бесценных товаров
- `deleteNonBuyItems` - Убирает из заказа бесценные товары
- `setOrderField` - Сохраняет введеные пользователем данные в поля заказа
- `validateOrder` - Валидирует форму заказа
- `validateContacts` - Валидирует форму контактов

Взаимодействие Модели с Отображением осуществляется в индексном файле, путем событийно-ориентированного подхода.

## События

1. `items:changed` - срабатывает при получении массива товаров с сервера. Происходит наполнение страницы каталога карточками товаров:

```
events.on('items:changed', () => {
	page.catalog = appData.catalog.map((item) => {
		const card = new CardCatalog(cloneTemplate(cardCatalogTemplate), {
			onClick: () => events.emit('card:select', item),
		});
		return card.render({
			title: item.title,
			image: item.image,
			categoryClass: item.category,
			category: item.category,
			price: item.price,
		});
	});
});
```

2. `card:select` - срабатывает при клике по карточке товара в каталоге и генерирует событие установки id товара в поле превью модели данных и также уведомляет о событии `preview:changed`, которое рендерит карточку превью по id товара

```
// AppData.ts
setPreview(item: IProduct) {
	this.preview = item.id;
	this.emitChanges('preview:changed', item);
}

// index.ts
events.on('card:select', (item: IProduct) => {
	appData.setPreview(item);
});

events.on('preview:changed', (item: IProduct) => {
	const showItem = (item: IProduct) => {
		// Логика
	};

	if (item) {
		....
	}
});
```

3. `order:changed` - генерирует событие изменения в корзине(заказе) - вызывается метод добавления/удаления товара в корзине, подсчитывается сумма и изменяется отображение количества товаров в корзине.

```
events.on('order:changed', (item: IProduct) => {
	appData.toggleOrderedItem(item.id);
	appData.getTotal();
	page.counter = appData.order.items.length;
});
```

4. `basket:open` - событие открытия корзины. Происходит при клике по значку корзины. Отображает актуальную информацию о товарах в корзине.

```
events.on('basket:open', () => {
	const cards = appData.getOrderedItems().map((item, index) => {
		// Какой-то код
	});
	modal.render({
		content: basket.render({
			...
		}),
	});
});
```

5. `order:open` - событие открытия формы заказа (выбор способа оплаты и адреса доставки)

```
events.on('order:open', () => {
	appData.deleteNonBuyItems(appData.noPriceItems);
	modal.render({
		content: order.render({
			...
		}),
	});
});
```

6. `order:submit` - событие сабмита формы заказа (выбор способа оплаты и адреса доставки)

```
events.on('order:submit', () => {
	modal.render({
		.....
	});
});
```

7. `update:payment` - событие обновляет способ оплаты

8. `orderErrors:change` и `contactsErrors:change` - событие возникающее при валидации формы в целом

9. `/^(order|contacts)\..*:change/` - событие для валидации полей форм. Вызывается при каждом введнном символе в поле ввода и вызывает метод, устанавливающий значение из поля в модель заказа.

10. `contacts:submit` - событие возникающее при клике по кнопке сабмита в форме контактов. Происходит отправка заказа на сервер и при успешном ответе рендерится модальное окно `Success`

11. `order:success` - событие при клике на кнопку "за новыми покупками"

12. `modal:open`, `modal:close` - возникают при открытии/закрытии модального окна и отвечают за блокировку/разблокировку скролла
